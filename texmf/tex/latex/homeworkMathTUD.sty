\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{exercisesMathTUD}[2019/03/09]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PACKAGE DESCRIPTION |
% ---------------------
% This package provides environments for typesetting the results of exercises at TU Dresden.
% There are two general package options which generally just change the title of every page:
% - homework: sets 'Hausaufgabe' as the main title and the specific setting of your exercise groups
% - presentExercise: stes the current exercise number as the main tilte and some attributes of the module
%
%----------------------
%
% Attention: the following commands have to be redefined by \renewcommand{cmd}{def} after loading the package:
% - \name : your full name (is going to be displayed in both options)
% - \matnr : your personal student's number (Matrikel-Nummer) ( displayed only in homework mode)
% - \modul : the modul you are the exercises writing for (both options)
% - \tutor : name of your tutor (displayed only in presentExercise option)
% - \group : specification of your exercise group - usually the exact date of the exercise (display only in homework mode)
% - \period : specification of the current period of student's year (displayed only in presentExercise mode)
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages for makro handling
\RequirePackage{kvoptions}
\RequirePackage{xifthen}
\RequirePackage{xparse}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages for font setting
\RequirePackage[T1]{fontenc}
\RequirePackage[ngerman]{babel}
\RequirePackage[utf8]{inputenc}

% New font OpenSans included
\@ifpackageloaded{opensans}{}{\usepackage[scale=1]{opensans}}
\ifx\osfamily\undefined
    \newcommand*{\osfamily}{\fontfamily{fos}\selectfont}
    \DeclareTextFontCommand{\textos}{\osfamily}
\fi

\RequirePackage{tikz}
\usetikzlibrary{calc,arrows}
\RequirePackage[ntheorem,framemethod=TikZ]{mdframed}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages for theorem environments
\RequirePackage{amsmath,amssymb,amsfonts,mathtools}
\RequirePackage[amsmath,thmmarks,framed]{ntheorem}


%\ifx\thename\undefined
%\newcommand*{\thename}{\hfill}
%\newcommand*{\name}[1]{\renewcommand{\thename}{#1}}
%\fi
%\ifx\thematnr\undefined
%\newcommand*{\thematnr}{\hfill}
%\newcommand*{\matnr}[1]{\renewcommand{\thematnr}{#1}}
%\fi
%\ifx\themodul\undefined
%\newcommand*{\themodul}{\hfill}
%\newcommand*{\modul}[1]{\renewcommand{\themodul}{#1}}
%\fi


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% colour settings
\RequirePackage{xcolor}
\@ifpackageloaded{tudscrcolor}{}{\RequirePackage[table,dvipsnames]{tudscrcolor}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Counter
\RequirePackage{chngcntr}
\newcounter{taskcount}
\newcounter{blattcount}
\newcounter{themcount}

\numberwithin{page}{blattcount}

\counterwithout{equation}{section}
\counterwithin{equation}{blattcount}
\counterwithin{figure}{blattcount}
\counterwithin{table}{blattcount}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Defining pagestyle (header and footer)
\pagestyle{plain}
%\renewcommand{\headrulewidth}{0pt}
%\renewcommand{\footrulewidth}{0pt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Defining the title-header
\newcommand{\header}{%
        {\osfamily%
            \fcolorbox{cddarkblue}{cdblue!20}{%
                \begin{minipage}{\dimexpr0.7\linewidth-\fboxrule-\fboxsep}
                    {\huge \textbf{Hausaufgaben}} \vspace{3pt} \\
                    \textbf{\themodul} -- Übungsblatt \theblattcount
                \end{minipage}%
                \begin{minipage}{\dimexpr0.3\linewidth-\fboxrule-\fboxsep}
                    \flushright \textbf{\thename} \\
                    Matr.-Nr. \thematnr
                \end{minipage}%
        }}%
    }%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Environment for a new exercise sheet
\newcommand{\scorebox}[1]{%
    \begin{tikzpicture}[decoration=penciline, decorate]%
    \pgfmathsetseed{1237}%
    \node (n1) [decorate,draw=cdorange, fill=cdorange!10,thick,align=center, inner ysep=3mm, inner xsep=2mm] at (0,0) {\osfamily\bfseries\large #1 BE};
    \end{tikzpicture}%
}


\NewDocumentEnvironment{exercisePage}{O{} O{}}{%
    \pagebreak%
    \stepcounter{blattcount}%
    \setcounter{page}{1}%
    \header \\[6pt] % header comment is defined depending on homework / present exercise above
    \setcounter{figure}{0}%
    \setcounter{equation}{0}%
    \setcounter{table}{0}%
    \setcounter{themcount}{0}
    %
    \ifthenelse{\isempty{#1}}{%
        \ifthenelse{\isempty{#2}}{%
            % topic and score is empty
            %\vspace{12pt}%
        }{%
            % topic is empty but score is injected
            {\flushright \scorebox{#2} \par} %\vspace{-12pt}%
        }%end inner if
    }{%
        \ifthenelse{\isempty{#2}}{%
            % topic is injected but score is empty
            {\osfamily \itshape Thema: #1} \par%\\[12pt]%
        }{%
            % topic and score are injected
            \begin{minipage}{\textwidth - 3cm}
                {\osfamily \itshape Thema: #1}%
            \end{minipage}%
            \begin{minipage}{3cm}
                \flushright \scorebox{#2}%
            \end{minipage} \par %\\[6pt]%
        }%end inner if
    }%end outer if
}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% theorem environments for exercises and solutions
\newcommand{\skiparound}{10pt}

% >> Exercise
\theoremstyle{plain}
\theoremheaderfont{\osfamily\normalsize\bfseries\upshape}
\theorembodyfont{\osfamily\normalsize}
\theoremseparator{.}
\theoremsymbol{}
\newmdtheoremenv[%
backgroundcolor=cdblue!5,%
linecolor=cddarkblue,%
%innertopmargin=\boxskip,%
%innerbottommargin=\boxskip,%
%topline=true,%
%rightline=true,%
%leftline=true,%
%bottomline=true,%
%innertopmargin=3pt,%
%innerbottommargin=3pt,%
%leftmargin=-10pt,%
%rightmargin=-10pt,%
%frametitlefont=\sffamily\bfseries\color{black},%
%skipabove=5pt,%
%skipbelow=5pt,%
skipabove=\skiparound,%
skipbelow=\skiparound,%
nobreak,%
]{exercise}[taskcount]{Übung}

\newmdtheoremenv[%
backgroundcolor=cdblue!5,%
linecolor=cddarkblue,%
%innertopmargin=\boxskip,%
%innerbottommargin=\boxskip,%
%topline=true,%
%rightline=true,%
%leftline=true,%
%bottomline=true,%
%innertopmargin=3pt,%
%innerbottommargin=3pt,%
%leftmargin=-10pt,%
%rightmargin=-10pt,%
%frametitlefont=\sffamily\bfseries\color{black},%
%skipabove=5pt,%
%skipbelow=5pt,%
skipabove=\skiparound,%
skipbelow=\skiparound,%
nobreak,%
]{homework}[taskcount]{Hausaufgabe}

\newmdtheoremenv[%
backgroundcolor=cdblue!5,%
linecolor=cddarkblue,%
%innertopmargin=\boxskip,%
%innerbottommargin=\boxskip,%
%topline=true,%
%rightline=true,%
%leftline=true,%
%bottomline=true,%
%innertopmargin=3pt,%
%innerbottommargin=3pt,%
%leftmargin=-10pt,%
%rightmargin=-10pt,%
%frametitlefont=\sffamily\bfseries\color{black},%
%skipabove=5pt,%
%skipbelow=5pt,%
skipabove=\skiparound,%
skipbelow=\skiparound,%
nobreak,%
]{aufgabe}[taskcount]{Aufgabe}

\theoremstyle{plain}
\theorempreskip{6pt}
\theorempostskip{6pt}
\theoremheaderfont{\osfamily\normalsize\bfseries\upshape}
\theorembodyfont{}
\theoremseparator{.}
\newtheorem{lemma}{Lemma}
\counterwithin{lemma}{blattcount}

%
% >> Solution
\newtheoremstyle{solutionstyle}%
{\item[\hskip\labelsep {\theorem@headerfont ##1}\theorem@separator]}%
{\item[\hskip\labelsep {\theorem@headerfont ##1}\ (##3)\theorem@separator]}

\theoremstyle{solutionstyle}
\theoremheaderfont{\normalfont\normalsize\bfseries}
\theorembodyfont{\normalfont}
\theoremseparator{\textbf{.}}
\theorempreskip{5pt}
\theorempostskip{5pt}
\theoremsymbol{$\square$}
\newtheorem{solution}{Lösung}

\NewDocumentEnvironment{correction}{O{cdpurple}}{\color{#1}\osfamily\itshape}{}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                         PROOF ENVIRONMENTS                          %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% >> proof
\newtheoremstyle{proofstyle}%
{\item[\hskip\labelsep {\theorem@headerfont ##1}\theorem@separator]}%
{\item[\hskip\labelsep {\theorem@headerfont ##1}\ (##3)\theorem@separator]}

\theoremstyle{proofstyle}
\theoremheaderfont{\normalsize\slshape}
\theorembodyfont{}
\theoremseparator{.}
\theorempreskip{0pt}
\theorempostskip{5pt}
\theoremsymbol{$\square$}
\newtheorem{proof}{Beweis}

% >> Equivalences
\newcommand{\hinrichtung}{\item[\bfseries ($\boldsymbol{\Rightarrow}$)]}
\newcommand{\rueckrichtung}{\item[\bfseries ($\boldsymbol{\Leftarrow}$)]}
\newenvironment{proof-equivalence}[1][]{%
    \ifthenelse{\isempty{#1}}%
        {\begin{description}}%
        {\begin{description}[topsep=-\parskip]}%
}{%
        \end{description}%
}%
\newenvironment{proof_equiv}{\begin{proof}\begin{description}}{\end{description}\end{proof}}

% >> inductions
\newcommand{\ianfang}[1][]{%
    \ifthenelse{\isempty{#1}}{%
        % no parameter
        \item[\textbf{(IA)}]%
    }{%
        %parameter exists
        \item[\textbf{(IA)}] {#1 :} %\hfill \\%
    }%
}

\newcommand{\ivorraussetzung}{\item[\bfseries (IV)]}

\newcommand{\ischritt}[1][]{%
    \ifthenelse{\isempty{#1}}{%
        % no parameter
        \item[\textbf{(IS)}]
    }{%
        % parameter exists
        \item[\textbf{(IS)}] {#1 :} %\\
    }%
}

% two optional arg's:
% #1 = induced variable 
% #2 = vert. space before (IA): parskip (default) or nopreskip
\NewDocumentEnvironment{induction}{O{} O{}}{%
    \ifthenelse{ \isempty{#1} }{}{%
        Vollständige Induktion nach #1:
    }%---
    \ifthenelse{ \equal{#2}{nopreskip} }{%
        \begin{description}[topsep=-\parskip]
    }{%
        \begin{description}
    }%
}{%
    \end{description}%
}

\newenvironment{proof_induction}[1][]{%
    \begin{proof}
        \begin{induction}[#1][nopreskip]%
}{%
        \end{induction}
    \end{proof}%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\RequirePackage{titlesec}
\titleformat*{\section}{\bfseries\osfamily\Large}%{}{20pt}{}%
\titlespacing*{\section}{0pt}{12pt}{0pt}
\titleformat*{\subsection}{\itshape\osfamily\large}
\titlespacing*{\subsection}{0pt}{0pt}{6pt}

\newcommand{\task}[1]{\section*{#1}}
\newcommand{\subtask}[1]{\subsection*{#1}}
